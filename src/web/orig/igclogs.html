<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="style.css">
<meta charset='utf-8'>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta http-equiv="Refresh" content="10">
<title>GXAirCom</title>
<script language="javascript" type="text/javascript">
  var pageNumber=6;

  /* Called when a message is received from the server*/
  function onMessage(evt) {
    /* Print out our received message */
    console.log("Received: " + evt.data);
    /* Update circle graphic with LED state */
    var myObj = JSON.parse(evt.data);
    var years = {};

    for (var key of Object.keys(myObj)) {
      console.log(key + " -> " + myObj[key]);
      if (key == "igclist"){

        var fl = myObj[key].split(";");
            var divElem = document.getElementById(key);
            fl.forEach(fpath => {
              const fname = fpath.split('/').slice(-1);
              const year = parseInt(fname[0].split('_')[0].slice(-2)) + 2000;
              const month = parseInt(fname[0].split('_')[0].slice(-4,-2));
              const day = parseInt(fname[0].split('_')[0].slice(-6,-4));
              if (year in years){
                years[year].push({'path':fpath,'fname':fname,'year':year,'month':month,'day':day});
              }else{
                years[year] = [{'path':fpath,'fname':fname,'year':year,'month':month,'day':day}];
              }
            });

            console.log("UnOrdered",years);
            if ('NaN' in years) delete years['NaN'];

            Object.keys(years).sort( (a,b) => b-a).forEach( y => {
              if (y && y != 'NaN'){
                var el = document.createElement("h3");
                el.textContent = y;
                divElem.appendChild(el);
                var ordered = years[y].sort( (a,b) => new Date(b.year,b.month-1,b.day) - new Date(a.year,a.month-1,a.day) );
                ordered.forEach( t => {
                  var el = document.createElement("p");
                  var record = "<a href='/download?igc="+String(t.path)+"' download class='igc_link'>" + t.fname + "</a>";
                  record += "<a href='/deleteigc?igc="+String(t.path)+"' target='_self' style='color:red;'> [X] </a>";
                  el.innerHTML =  record;
                  divElem.appendChild(el);
                });
              }
            });

        continue;
      }
      var e=document.getElementById(key);
      if (e == null) continue;
      if (e instanceof HTMLSelectElement) {
        document.getElementById(key).value = myObj[key];
      }else if ((e instanceof HTMLInputElement ) && (e.getAttribute('type') == 'checkbox')){
        if (myObj[key] == 1){
          document.getElementById(key).checked = true;
        }else{
          document.getElementById(key).checked = false;
        }
      }else{
        document.getElementById(key).textContent = myObj[key];
        document.getElementById(key).value = myObj[key];
      }
    }
  };
</script>
<script type="text/javascript" src="scripts.js"></script>
</head>
<body>
  <div style="text-align:left;display:inline-block;color:#eaeaea;min-width:340px;">
    <div style='text-align:center;color:#eaeaea;'>
      <noscript>JavaScript aktivieren um GXAirCom benutzen zu k√∂nnen<br></noscript>
      <h1 id="appname"></h1>
      <h3 id="buildDate"></h3>
      <h3 id="pilot"></h3>
      <h3 id="myIP"></h3>
    </div>
    <style>td{padding:0px 5px;}</style>
    <h1>IGC File List</h1>
    <div id="test"></div>
    <div id="igclist">
    </div>
    <div></div>
    <p></p>
    <table style="width:100&#37;">
      <tr>
        <td style="width:100&#37;">
          <button onClick="location.href='/index.html'">main menu</button>
        </td>
      </tr>
    </table>
    <p></p>
    <div style='text-align:right;font-size:11px;'><hr><a href='https://www.getronix.at' target='_blank' style='color:#aaa;'>GXAirCom by Gerald Eichler</a>
    </div>
  </div>
</body>
</html>